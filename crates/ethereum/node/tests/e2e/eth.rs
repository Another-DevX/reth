use crate::utils::eth_payload_attributes;
use alloy_genesis::Genesis;
use alloy_primitives::{address, bytes, hex, map::AddressMap, Address, Bytes, U256};
use alloy_provider::Provider;
use alloy_rpc_types_eth::{state::AccountOverride, TransactionRequest};
use reth_chainspec::{ChainSpecBuilder, MAINNET};
use reth_e2e_test_utils::{
    node::NodeTestContext, setup, transaction::TransactionTestContext, wallet::Wallet,
};
use reth_node_builder::{NodeBuilder, NodeHandle};
use reth_node_core::{args::RpcServerArgs, node_config::NodeConfig};
use reth_node_ethereum::EthereumNode;
use reth_tasks::TaskManager;
use std::sync::Arc;

const EIP7702_DELEGATION_DESIGNATOR: [u8; 3] = hex!("0xef0100");

#[tokio::test]
async fn can_run_eth_node() -> eyre::Result<()> {
    reth_tracing::init_test_tracing();

    let (mut nodes, _tasks, wallet) = setup::<EthereumNode>(
        1,
        Arc::new(
            ChainSpecBuilder::default()
                .chain(MAINNET.chain)
                .genesis(serde_json::from_str(include_str!("../assets/genesis.json")).unwrap())
                .cancun_activated()
                .prague_activated()
                .build(),
        ),
        false,
        eth_payload_attributes,
    )
    .await?;

    let mut node = nodes.pop().unwrap();
    let raw_tx = TransactionTestContext::transfer_tx_bytes(1, wallet.inner).await;

    // make the node advance
    let tx_hash = node.rpc.inject_tx(raw_tx).await?;

    // make the node advance
    let (payload, _) = node.advance_block().await?;

    let block_hash = payload.block().hash();
    let block_number = payload.block().number;

    // assert the block has been committed to the blockchain
    node.assert_new_block(tx_hash, block_hash, block_number).await?;

    let provider = node.inner.rpc_server_handles.rpc.eth_http_provider().unwrap();

    let to = address!("0xfabb0ac9d68b0b445fb7357272ff202c5651694b");
    let target = address!("0xfabb0ac9d68b0b445fb7357272ff202c5651694a");

    let overrides = AddressMap::from_iter([
        (
            address!("0xfabb0ac9d68b0b445fb7357272ff202c5651694b"),
            AccountOverride {
                balance: Some(U256::MAX.div_ceil(2.try_into().unwrap())),
                ..Default::default()
            },
        ),
        (
            // 0xfbd58f812e771407f3e00047d5e81efdd513e7bddc168303a176a74e462b1a29
            // -> 0x45a2428367e115e9a8b0898dfb194a4bdcd09a2300000000000201000000001b
            //
            // ,"stateDiff":{
            //  "0xfbd58f812e771407f3e00047d5e81efdd513e7bddc168303a176a74e462b1a29":
            //  "0x45a2428367e115e9a8b0898dfb194a4bdcd09a2300000000000201000000001b"
            // }
            //
            to,
            AccountOverride {
                state_diff: None,
                code: Some(
                    Bytes::from([&EIP7702_DELEGATION_DESIGNATOR, &target[..]].concat())
                ),
                    ..Default::default()
            }
                //  {
                //     to: Some(op.eoa.into()), input:
            //     bytes!("12aaac70670d9fe38cfed3e82e49c8ebf5e225bf5bf78361b59bf32fbe4c2021a3e4d704").into(),
            //     gas: Some(1000000), ..Default::default()
            // }, &overrides).await = Err(
            //     ErrorResp(
            //         ErrorPayload {
            //             code: 3,
            //             message: "execution reverted",
            //             data: None,
            //         },
            //     ),
            // )


            // // request.op.eoa,
            // to,
            // AccountOverride {
            //     state_diff: None,
            //     // we manually etch the 7702 designator since we do not have a signed auth item
            //     /*code: request.auth.map(|addr| {
            //         Bytes::from([&EIP7702_DELEGATION_DESIGNATOR, &addr[..]].concat())
            //     }),*/
            //     code: Some(bytes!("0x60806040526004361061021d575f3560e01c806384b0196e11610122578063cb4774c4116100aa578063e9ae5c531161006e578063e9ae5c5314610710578063f0c60f1a14610723578063faba56d814610737578063fac750e014610756578063ff619c6b1461076a57610224565b8063cb4774c414610666578063cebfe33614610687578063d03c7914146106a6578063dcc09ebf146106c5578063e537b27b146106f157610224565b8063a840fe49116100f1578063a840fe49146105cb578063ad077083146105ea578063b70e36f014610609578063b75c7dc614610628578063bf5309691461064757610224565b806384b0196e1461052f578063887f7d7c1461055657806394430fa514610575578063a2e2f9301461059c57610224565b806335058501116101a557806360d2f33d1161017457806360d2f33d146104815780636ae269cc146104b45780636fd91454146104d05780637656d304146104ef5780637b8e4ecc1461050e57610224565b806335058501146104095780634223b5c214610423578063515c9d6d14610442578063598daac41461046257610224565b80631626ba7e116101ec5780631626ba7e146103245780631a912f3e1461035c57806320606b701461039d5780632081a278146103d05780632f3f30c7146103ef57610224565b80630cef73b41461025d57806311a86fd61461029857806312aaac70146102d7578063136a12f71461030357610224565b3661022457005b5f3560e01c63bc197c81811463f23a6e6182141763150b7a028214171561024f57806020526020603cf35b50633c10b94e5f526004601cfd5b348015610268575f5ffd5b5061027c610277366004613a66565b61078b565b6040805192151583526020830191909152015b60405180910390f35b3480156102a3575f5ffd5b506102bf73323232323232323232323232323232323232323281565b6040516001600160a01b03909116815260200161028f565b3480156102e2575f5ffd5b506102f66102f1366004613aae565b6107a5565b60405161028f9190613b07565b34801561030e575f5ffd5b5061032261031d366004613b7d565b610895565b005b34801561032f575f5ffd5b5061034361033e366004613a66565b6109a7565b6040516001600160e01b0319909116815260200161028f565b348015610367575f5ffd5b5061038f7f84fa2cf05cd88e992eae77e851af68a4ee278dcff6ef504e487a55b3baadfbe581565b60405190815260200161028f565b3480156103a8575f5ffd5b5061038f7f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f81565b3480156103db575f5ffd5b506103226103ea366004613be5565b610a11565b3480156103fa575f5ffd5b50610343630707070760e51b81565b348015610414575f5ffd5b50610343631919191960e11b81565b34801561042e575f5ffd5b506102f661043d366004613aae565b610b24565b34801561044d575f5ffd5b5061038f5f51602061428b5f395f51905f5281565b34801561046d575f5ffd5b5061032261047c366004613c20565b610b62565b34801561048c575f5ffd5b5061038f7ff178cee9828e64c9fc454720a91d5c4df586b4718ab6a13f7af8a7db3f920e2c81565b3480156104bf575f5ffd5b50686d3d4e7fb92a5238155461038f565b3480156104db575f5ffd5b5061038f6104ea366004613c63565b610ccc565b3480156104fa575f5ffd5b50610322610509366004613cd8565b610e2d565b348015610519575f5ffd5b50610522610ef1565b60405161028f9190613d0a565b34801561053a575f5ffd5b50610543610f0a565b60405161028f9796959493929190613d55565b348015610561575f5ffd5b50610322610570366004613deb565b610f30565b348015610580575f5ffd5b506102bf73307af7d28afee82092aa95d35644898311ca536081565b3480156105a7575f5ffd5b506105bb6105b6366004613aae565b610f73565b604051901515815260200161028f565b3480156105d6575f5ffd5b5061038f6105e5366004613ef2565b610f9b565b3480156105f5575f5ffd5b50610522610604366004613aae565b610fd4565b348015610614575f5ffd5b50610322610623366004613aae565b610fe7565b348015610633575f5ffd5b50610322610642366004613aae565b611012565b348015610652575f5ffd5b50610322610661366004613fa1565b611067565b348015610671575f5ffd5b5061067a61110b565b60405161028f9190613fe0565b348015610692575f5ffd5b5061038f6106a1366004613ef2565b61111f565b3480156106b1575f5ffd5b506105bb6106c0366004613aae565b611187565b3480156106d0575f5ffd5b506106e46106df366004613aae565b6111aa565b60405161028f9190614006565b3480156106fc575f5ffd5b5061032261070b366004614080565b61131c565b61032261071e366004613a66565b6113dc565b34801561072e575f5ffd5b5061038f61146d565b348015610742575f5ffd5b5061038f6107513660046140b3565b611500565b348015610761575f5ffd5b5061038f61163c565b348015610775575f5ffd5b506105bb6107843660046140d4565b61164f565b565b5f5f6107988585856118e2565b915091505b935093915050565b604080516080810182525f80825260208201819052918101919091526060808201525f828152686d3d4e7fb92a523817602052604081206107e590611aea565b905080515f036108085760405163395ed8c160e21b815260040160405180910390fd5b8051600619015f61081c8383016020015190565b60d881901c855260c881901c915060d01c60ff16600281111561084157610841613ac5565b8460200190600281111561085757610857613ac5565b9081600281111561086a5761086a613ac5565b90525060ff81161515604085015261088783838151811082025290565b606085015250919392505050565b3330146108b4576040516282b42960e81b815260040160405180910390fd5b83806108d357604051638707510560e01b815260040160405180910390fd5b6108dd8484611b50565b15610908576108eb85611b7a565b610908576040516303a6f8c760e21b815260040160405180910390fd5b5f83815260188590526004869052603881208152683c149ebf7b8e6c5e226020818152604092839020805460ff191686151590811790915583518981526001600160a01b038916928101929092526001600160e01b03198716938201939093526060810192909252907f7eb91b8ac56c0864a4e4f5598082d140d04bed1a4dd62a41d605be2430c494e1906080015b60405180910390a1505050505050565b5f5f5f6109b58686866118e2565b909250905081151581151516156109ef576109cf816107a5565b60400151806109ec57506109ec336109e683611b8e565b90611bbd565b91505b816109fe5763ffffffff610a04565b631626ba7e5b60e01b9695505050505050565b333014610a30576040516282b42960e81b815260040160405180910390fd5b8280610a4f57604051638707510560e01b815260040160405180910390fd5b5f848152683c149ebf7b8e6c5e2360205260409020610a6e8185611c67565b506001600160a01b0384165f9081526001820160205260409020610ab6846005811115610a9d57610a9d613ac5565b8254600160ff9092169190911b80198216845516151590565b50806001015f856005811115610ace57610ace613ac5565b60ff168152602081019190915260409081015f9081208181556001810182905560020155517fa17fd662986af6bbcda33ce6b68c967b609aebe07da86cd25ee7bfbd01a65a27906109979088908890889061412c565b604080516080810182525f8082526020820181905291810191909152606080820152610b5c6102f1686d3d4e7fb92a52381684611d9c565b92915050565b333014610b81576040516282b42960e81b815260040160405180910390fd5b8380610ba057604051638707510560e01b815260040160405180910390fd5b5f858152683c149ebf7b8e6c5e2360205260409020610bbf8186611de5565b506040610bcb82611f40565b10610be957604051635b18c3fd60e01b815260040160405180910390fd5b6001600160a01b0385165f9081526001820160205260409020610c2e856005811115610c1757610c17613ac5565b8254600160ff9092169190911b8082178455161590565b506008610c3a82611f91565b10610c5857604051635b18c3fd60e01b815260040160405180910390fd5b83816001015f876005811115610c7057610c70613ac5565b60ff1681526020019081526020015f205f01819055507f68c781b0acb659616fc73da877ee77ae95c51ce973b6c7a762c8692058351b4a87878787604051610cbb949392919061414f565b60405180910390a150505050505050565b5f80610ce88460408051828152600190920160051b8201905290565b90505f5b84811015610d9357600581901b86013586018035801530021790602080820135916040810135019081019035610d8385610d747f84fa2cf05cd88e992eae77e851af68a4ee278dcff6ef504e487a55b3baadfbe56001600160a01b03881687610d558888611fb2565b6040805194855260208501939093529183015260608201526080902090565b600190910160051b8801528690565b5050505050806001019050610cec565b505f610e007ff178cee9828e64c9fc454720a91d5c4df586b4718ab6a13f7af8a7db3f920e2c60018616610dcf85805160051b60209091012090565b686d3d4e7fb92a523815546040805194855260208501939093529183015260608201879052608082015260a0902090565b90505f8460011611610e1a57610e1581611fc3565b610e23565b610e23816120d9565b9695505050505050565b333014610e4c576040516282b42960e81b815260040160405180910390fd5b5f610e5684611b8e565b90508115610e9957610e688184611de5565b50610200610e7582611f40565b1115610e9457604051639b04a7d560e01b815260040160405180910390fd5b610ea5565b610ea38184611c67565b505b826001600160a01b0316847f30653b7562c17b712ebc81c7a2373ea1c255cf2a055380385273b5bf7192cc9984604051610ee3911515815260200190565b60405180910390a350505050565b6060610f05686d3d4e7fb92a52381961214d565b905090565b600f60f81b6060805f808083610f1e612221565b97989097965046955030945091925090565b3373307af7d28afee82092aa95d35644898311ca536014610f63576040516282b42960e81b815260040160405180910390fd5b610f6e833384612261565b505050565b600881901c5f908152686d3d4e7fb92a523814602052604081205460ff83161c600116610b5c565b5f610b5c82602001516002811115610fb557610fb5613ac5565b60ff168360600151805190602001205f1c5f9182526020526040902090565b6060610b5c610fe283611b8e565b61214d565b333014611006576040516282b42960e81b815260040160405180910390fd5b61100f81612284565b50565b333014611031576040516282b42960e81b815260040160405180910390fd5b61103a816122e0565b60405181907fe5af7daed5ab2a2dc5f98d53619f05089c0c14d11a6621f6b906a2366c9a7ab3905f90a250565b333014611086576040516282b42960e81b815260040160405180910390fd5b6110ce82828080601f0160208091040260200160405190810160405280939291908181526020018383808284375f920191909152506110c89250611add915050565b9061234f565b7faec6ef4baadc9acbdf52442522dfffda03abe29adba8d4af611bcef4cbe0c9ad82826040516110ff929190614181565b60405180910390a15050565b6060610f05686d3d4e7fb92a523813611aea565b5f33301461113f576040516282b42960e81b815260040160405180910390fd5b611148826123a7565b9050807f3d3a48be5a98628ecf98a6201185102da78bbab8f63a4b2d6b9eef354f5131f58360405161117a9190613b07565b60405180910390a2919050565b5f610b5c6001600160f81b0319808416146111a18461241c565b15159015151790565b5f818152683c149ebf7b8e6c5e2360209081526040918290208251918201909252606080825291905f6111dc83611f40565b90505f5b81811015611312575f6111f3858361242e565b6001600160a01b0381165f908152600187016020526040812091925061121882612487565b90505f5b8151811015611303575f828281518110611238576112386141af565b602002602001015190505f846001015f8360ff1681526020019081526020015f20905061128a6040805160a081019091525f808252602082019081526020015f81526020015f81526020015f81525090565b8260ff16600581111561129f5761129f613ac5565b816020019060058111156112b5576112b5613ac5565b908160058111156112c8576112c8613ac5565b9052506001600160a01b03871681528154604082015260028201546080820152806112f38b826124e0565b505050505080600101905061121c565b505050508060010190506111e0565b5050519392505050565b33301461133b576040516282b42960e81b815260040160405180910390fd5b686d3d4e7fb92a5238198115611386576113558184611de5565b5061020061136282611f40565b11156113815760405163490c363960e11b815260040160405180910390fd5b611392565b6113908184611c67565b505b826001600160a01b03167f31471c9e79dc8535d9341d73e61eaf5e72e4134b3e5b16943305041201581d88836040516113cf911515815260200190565b60405180910390a2505050565b6001600160f81b0319808416900361146257813560601c60148083108382180218808401908084039084110261141b686d3d4e7fb92a52381984611bbd565b611437576040516282b42960e81b815260040160405180910390fd5b61143f61258b565b604051818382375f388383875af4611459573d5f823e3d81fd5b50505050505050565b610f6e83838361259f565b5f33301461148d576040516282b42960e81b815260040160405180910390fd5b50686d3d4e7fb92a523815805460408051828152426020808301919091523382840152606090912063ffffffff169092019283905580518381529051686d3d4e7fb92a523813927f7328006ebae4716b8db9514af69091e0ad74bec61dfdc256ed5446b234aa5424928290030190a15090565b5f8082600581111561151457611514613ac5565b0361153657611524603c846141d7565b61152f90603c6141f6565b9050610b5c565b600182600581111561154a5761154a613ac5565b036115675761155b610e10846141d7565b61152f90610e106141f6565b600282600581111561157b5761157b613ac5565b0361159a5761158d62015180846141d7565b61152f90620151806141f6565b60038260058111156115ae576115ae613ac5565b036115d4576007600362015180808604918201929092069003620545ff8511020261152f565b5f5f6115df85612621565b50909250905060048460058111156115f9576115f9613ac5565b036116135761160a828260016126cb565b92505050610b5c565b600584600581111561162757611627613ac5565b036116385761160a826001806126cb565b5f5ffd5b5f610f05686d3d4e7fb92a523816612722565b5f8461165d575060016118da565b683c149ebf7b8e6c5e22631919191960e11b6004841061167b575083355b8361168a5750630707070760e51b5b6116948682611b50565b156116b0576116a287611b7a565b6116b0575f925050506118da565b5f818152601887905260048890526038812081526020839052604090205460ff16156116e1576001925050506118da565b5f81815273323232323232323232323232323232323232323260185260048890526038812081526020839052604090205460ff1615611725576001925050506118da565b5f81815260188790525f51602061428b5f395f51905f526004526038812081526020839052604090205460ff1615611762576001925050506118da565b5f8181527332323232323232323232323232323232323232326018525f51602061428b5f395f51905f526004526038812081526020839052604090205460ff16156117b2576001925050506118da565b631919191960e11b5f908152601887905260048890526038812081526020839052604090205460ff16156117eb576001925050506118da565b631919191960e11b5f90815273323232323232323232323232323232323232323260185260048890526038812081526020839052604090205460ff1615611837576001925050506118da565b631919191960e11b5f90815260188790525f51602061428b5f395f51905f526004526038812081526020839052604090205460ff161561187c576001925050506118da565b631919191960e11b5f9081527332323232323232323232323232323232323232326018525f51602061428b5f395f51905f526004526038812081526020839052604090205460ff16156118d4576001925050506118da565b5f925050505b949350505050565b5f806041831460408414171561191257306118fe86868661276e565b6001600160a01b03161491505f905061079d565b602183101561192557505f90508061079d565b506020198281018381118185180281189385019182013591601f19013560ff161561195657611953866127f6565b95505b505f611961826107a5565b805190915064ffffffffff164281109015151615611982575f92505061079d565b5f8160200151600281111561199957611999613ac5565b036119f4575f80603f86118735810290602089013502915091505f5f6119d8856060015180516020820151604090920151603f90911191820292910290565b915091506119e98a85858585612814565b965050505050611ad4565b600181602001516002811115611a0c57611a0c613ac5565b03611a9157606081810151805160208083015160409384015184518084018d9052855180820385018152601f8c018590049094028101870186529485018a8152603f9490941091820295910293611a88935f92611a81928d918d918291018382808284375f920191909152506128a692505050565b858561298d565b94505050611ad4565b600281602001516002811115611aa957611aa9613ac5565b03611ad457611ad18160600151806020019051810190611ac9919061420d565b878787612aac565b92505b50935093915050565b686d3d4e7fb92a52381390565b60405181546020820190600881901c5f8260ff841714611b1857505080825260ff8116601f80821115611b3a575b855f5260205f205b8160051c81015482860152602082019150828210611b2057505b508084525f920191825250602001604052919050565b5f63e9ae5c5360e01b6001600160e01b0319831614306001600160a01b03851614165b9392505050565b5f611b84826107a5565b6040015192915050565b5f818152686d3d4e7fb92a523818602052604081208054601f5263d4203f8b6004528152603f81208190611b73565b63978aab926004525f828152602481206001600160a01b03929092169168fbb67fda52d4bfb8be198301611bf85763f5a267f15f526004601cfd5b82611c0a5768fbb67fda52d4bfb8bf92505b80546001600160601b038116611c4e5760019250838160601c0315611c5f57600182015460601c8414611c5f57600282015460601c8414611c5f575b5f9250611c5f565b81602052835f5260405f2054151592505b505092915050565b63978aab926004525f828152602481206001600160a01b03929092169168fbb67fda52d4bfb8be198301611ca25763f5a267f15f526004601cfd5b82611cb45768fbb67fda52d4bfb8bf92505b80546001600160601b03811680611d2e5760019350848260601c03611cec5760018301805484556002840180549091555f9055611d93565b84600184015460601c03611d0d5760028301805460018501555f9055611d93565b84600284015460601c03611d26575f6002840155611d93565b5f9350611d93565b82602052845f5260405f20805480611d47575050611d93565b60018360011c039250826001820314611d77578285015460601c8060601b60018303870155805f52508060405f20555b5060018260011b17845460601c60601b1784555f815550600193505b50505092915050565b6318fb58646004525f8281526024902081015468fbb67fda52d4bfb8bf81141502611dc683612722565b8210610b5c57604051634e23d03560e01b815260040160405180910390fd5b63978aab926004525f828152602481206001600160a01b03929092169168fbb67fda52d4bfb8be198301611e205763f5a267f15f526004601cfd5b82611e325768fbb67fda52d4bfb8bf92505b80546001600160601b0381168260205280611ef4578160601c80611e60578560601b84556001945050611d93565b858103611e6d5750611d93565b600184015460601c80611e8e578660601b6001860155600195505050611d93565b868103611e9c575050611d93565b600285015460601c80611ebe578760601b600287015560019650505050611d93565b878103611ecd57505050611d93565b5f928352604080842060019055918352818320600290558252902060039055506007908117905b845f5260405f208054611f3657600191821c808301825591945081611f22578560601b600317845550611d93565b8560601b8285015582600201845550611d93565b5050505092915050565b63978aab926004525f8181526024812080548060a01b60a01c8060011c9350808260601c1517611f8957600193508383015415611f8957600293508383015415611f8957600393505b505050919050565b5f81545b8015611fac57600191820191811901811618611f95565b50919050565b5f8183604051375060405120919050565b7f1573faccac6157d4ebee0d442594e3485773f644f6911048eedc542abf85a4777f0000000000000000000000004ee65f4ced87ff98fd40627ac19c159e99c9d29530147f00000000000000000000000000000000000000000000000000000000000de9fb4614166120b65750604080517f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f81527f6c157b110f3bc0280dba8ae624dab3ba623d9bab8692057c96d59c9188d52cb260208201527fae209a0b48f21c054280f2455d32cf309387644879d9acbd8ffc1991638118859181019190915246606082015230608082015260a090205b6719010000000000005f5280601a5281603a52604260182090505f603a52919050565b5f5f5f6120e4612221565b915091506040517f91ab3d17e3a50a9d89e63fd30b92be7f5336b03b287bb946787a83a9d62a27665f5282516020840120602052815160208301206040523060605260805f206020526119015f52846040526042601e20935080604052505f6060525050919050565b63978aab926004525f818152602481206060915068fbb67fda52d4bfb8bf81548060a01b60a01c6040519450846020018260601c92508383141583028152816121db5782156121d657600191508185015460601c925082156121d6578284141590920260208301525060028381015460601c9182156121d6576003915083831415830260408201525b61220b565b600191821c915b82811015612209578581015460601c858114158102600583901b84015293506001016121e2565b505b8186528160051b81016040525050505050919050565b604080518082018252600a8152692232b632b3b0ba34b7b760b11b60208083019190915282518084019093526005835264302e302e3160d81b9083015291565b6001600160a01b03831661227957610f6e8282612b7f565b610f6e838383612b98565b600881901c5f908152686d3d4e7fb92a523814602052604090208054600160ff84161b1790556040518181527f4d9dbebf1d909894d9c26fe228c27cec643b2cb490124e5b658f4edd203c20c19060200160405180910390a150565b5f818152686d3d4e7fb92a52381760209081526040808320839055686d3d4e7fb92a523818909152902080546001019055686d3d4e7fb92a52381361232e686d3d4e7fb92a52381683612be2565b61234b5760405163395ed8c160e21b815260040160405180910390fd5b5050565b80518060081b60ff175f60fe8311612378575050601f8281015160081b8217908083111561239f575b60208401855f5260205f205b828201518360051c8201556020830192508483106123845750505b509092555050565b5f6123b182610f9b565b90505f686d3d4e7fb92a523813606084015184516020808701516040808901519051959650612408956123e695949301614228565b60408051601f198184030181529181525f85815260048501602052209061234f565b6124156003820183612ce0565b5050919050565b5f61242682612df2565b151592915050565b63978aab926004525f828152602481208281015460601c915068fbb67fda52d4bfb8bf8214158202915061246184611f40565b831061248057604051634e23d03560e01b815260040160405180910390fd5b5092915050565b604051815460208201905f905b80156124ca5761ffff81166124af576010918201911c612494565b8183526020600582901b16909201916001918201911c612494565b5050601f198282030160051c8252604052919050565b604080516060815290819052829050825160018151018060051b661d174b32e2c55360208403518181061582820402905080831061257a57828117810160608614826020018701604051181761254657828102601f19870152850160200160405261257a565b602060405101816020018101604052808a52601f19855b888101518382015281018061255d57509184029181019190915294505b505082019390935291909152919050565b612593612e3b565b61078957610789612e5a565b5f6125a984612df2565b9050806003036125c4576125be848484612e67565b50505050565b365f365f846125da57637f1812755f526004601cfd5b5085358087016020810194503592505f90604011600286141115612608575050602080860135860190810190355b61261788888887878787612eff565b5050505050505050565b5f80806126be61263462015180866141d7565b5f5f5f620afa6c8401935062023ab1840661016d62023ab082146105b48304618eac84048401030304606481048160021c8261016d0201038203915060996002836005020104600161030161f4ff830201600b1c84030193506b030405060708090a0b0c010260a01b811a9450506003841061019062023ab1880402820101945050509193909250565b9196909550909350915050565b5f620afa6c1961019060038510860381810462023ab10260649290910691820461016d830260029390931c9290920161f4ff600c60098901060261030101600b1c8601019190910301016201518002949350505050565b6318fb58646004525f818152602481208019548060011c9250806124155781545f9350156124155760019250828201541561241557600292508282015415612415575060039392505050565b5f604051826040811461278957604181146127b057506127e1565b60208581013560ff81901c601b0190915285356040526001600160ff1b03166060526127c1565b60408501355f1a6020526040856040375b50845f526020600160805f60015afa5191505f606052806040523d6127ee575b638baa579f5f526004601cfd5b509392505050565b5f815f526020600160205f60025afa5190503d61280f57fe5b919050565b5f6040518681528560208201528460408201528360608201528260808201525f5f5260205f60a0836101005afa503d6128715760203d60a0836dd01ea45f9efd5c54f037fa57ea1a5afa503d6128715763d0d5039b3d526004601cfd5b505f516001147f7fffffff800000007fffffffffffffffde737d56d38bcf4279dce5617e3192a8851110905095945050505050565b6128db6040518060c0016040528060608152602001606081526020015f81526020015f81526020015f81526020015f81525090565b815160c08110611fac5760208301818101818251018281108260c0830111171561290757505050611fac565b80815101925080602082015101818110838211178285108486111717156129315750505050611fac565b82815160208301011183855160208701011117156129525750505050611fac565b8386528060208701525060408101516040860152606081015160608601526080810151608086015260a081015160a086015250505050919050565b5f5f5f61299c88600180613019565b905060208601518051602082019150604088015160608901518451600d81016c1131b430b63632b733b2911d1160991b60981c8752848482011060228286890101515f1a14168160138901208286890120141685846014011085851760801c1074113a3cb832911d113bb2b130baba34371733b2ba1160591b60581c8589015160581c14161698505080865250505087515189151560021b600117808160218c5101511614602083118816169650508515612a8057602089510181810180516020600160208601856020868a8c60025afa60011b5afa51915295503d9050612a8057fe5b5050508215612aa157612a9e8287608001518860a001518888612814565b92505b505095945050505050565b5f6001600160a01b038516156118da57604051853b612b3c578260408114612adc5760418114612b035750612b76565b60208581013560ff81901c601b0190915285356040526001600160ff1b0316606052612b14565b60408501355f1a6020526040856040375b50845f526020600160805f60015afa5180871860601b3d119250505f60605280604052612b76565b631626ba7e60e01b80825285600483015260248201604081528460448401528486606485013760208160648701858b5afa90519091141691505b50949350505050565b5f385f3884865af161234b5763b12d13eb5f526004601cfd5b816014528060345263a9059cbb60601b5f5260205f604460105f875af18060015f511416612bd857803d853b151710612bd8576390b8ec185f526004601cfd5b505f603452505050565b6318fb58646004525f8281526024812068fbb67fda52d4bfb8bf8303612c0f5763f5a267f15f526004601cfd5b82612c215768fbb67fda52d4bfb8bf92505b80195480612c82576001925083825403612c4e5760018201805483556002830180549091555f9055611c5f565b83600183015403612c6c5760028201805460018401555f9055611c5f565b83600283015403611c46575f6002830155611c5f565b81602052835f5260405f20805480612c9b575050611c5f565b60018360011c039250826001820314612cc557828401548060018303860155805f52508060405f20555b5060018260011b178319555f81555060019250505092915050565b6318fb58646004525f8281526024812068fbb67fda52d4bfb8bf8303612d0d5763f5a267f15f526004601cfd5b82612d1f5768fbb67fda52d4bfb8bf92505b8019548160205280612dc357815480612d3f578483556001935050611c5f565b848103612d4c5750611c5f565b600183015480612d6757856001850155600194505050611c5f565b858103612d75575050611c5f565b600284015480612d915786600286015560019550505050611c5f565b868103612da057505050611c5f565b5f9283526040808420600190559183528183206002905582529020600390555060075b835f5260405f208054611d9357600191821c8381018690558083019182905590821b8217831955909250611c5f565b6003690100000000007821000260b09290921c69ffff00000000ffffffff16918214026901000000000078210001821460011b6901000000000000000000909214919091171790565b5f60205f5f303c60176001303b03105f5160e81c62ef01001416905090565b639f03a0265f526004601cfd5b600360b01b929092189181358083018035916020808301928686019291600586901b9091018101831090861017604082901c1715612eac57633995943b5f526004601cfd5b505f5b83811461145957365f8260051b850135808601602081019350803592505084828401118160401c1715612ee957633995943b5f526004601cfd5b50612ef58983836113dc565b5050600101612eaf565b73307af7d28afee82092aa95d35644898311ca535f193301612f5b576040811015612f3d576040516355fe73fd60e11b815260040160405180910390fd5b612f47823561310a565b612f5684846020850135613131565b611459565b80612f8a57333014612f7f576040516282b42960e81b815260040160405180910390fd5b612f5684845f613131565b6020811015612fac576040516355fe73fd60e11b815260040160405180910390fd5b8135612fb78161310a565b5f5f612fe1612fc7888886610ccc565b60208087108188180218808801908088039088110261078b565b9150915081613002576040516282b42960e81b815260040160405180910390fd5b61300d878783613131565b50505050505050505050565b6060835180156127ee576003600282010460021b60405192507f4142434445464748494a4b4c4d4e4f505152535455565758595a616263646566601f526106708515027f6768696a6b6c6d6e6f707172737475767778797a303132333435363738392d5f18603f526020830181810183886020010180515f82525b60038a0199508951603f8160121c16515f53603f81600c1c1651600153603f8160061c1651600253603f811651600353505f518452600484019350828410613094579052602001604052613d3d60f01b60038406600204808303919091525f861515909102918290035290038252509392505050565b61311381610f73565b1561100657604051633ab3447f60e11b815260040160405180910390fd5b8061314157610f6e838383613581565b5f818152683c149ebf7b8e6c5e23602052604090206131bf6040805160e081018252606060c0820181815282528251602080820185528282528084019190915283518082018552828152838501528351808201855282815282840152835180820185528281526080840152835190810190935282529060a082015290565b5f6131c983611f40565b90505f5b8181101561321b575f6131e0858361242e565b90506001600160a01b0381161561321257604084015161320090826135d8565b506060840151613210905f6124e0565b505b506001016131cd565b505f5f5b868110156133a457600581901b88013588018035801530021790602080820135916040810135019081019035821561325e5761325b8387614277565b95505b6004811015613270575050505061339c565b813560e01c63a9059cbb8190036132be5761328b8a86611bbd565b61329957505050505061339c565b60408901516132a890866135d8565b506132bc602484013560608b0151906135f7565b505b8063ffffffff1663095ea7b30361331e576132d98a86611bbd565b6132e757505050505061339c565b60248301355f036132fc57505050505061339c565b885161330890866135d8565b5061331c600484013560208b0151906135f7565b505b8063ffffffff166387517c4503613396576001600160a01b0385166e22d473030f116ddee9f6b43ac78ba31461335857505050505061339c565b60448301355f0361336d57505050505061339c565b613380600484013560808b0151906135f7565b50613394602484013560a08b0151906135f7565b505b50505050505b60010161321f565b505f80805260018501602052604090206133be908261360d565b6040830151516060840151516133d491906136cb565b5f6134076133e58560400151515190565b60606040518260201c5f031790508181528160051b6020820101604052919050565b90505f5b6040850151515181101561345357604085015151600582901b0160200151613449826134378330613791565b85919060059190911b82016020015290565b505060010161340b565b5061345f888888613581565b5f5b604085015151518110156134f857604085015151600582901b01602001515f61348a8230613791565b6001600160a01b0383165f90815260018a016020908152604090912060608a015151600587901b01909101519192506134ee916134e9906134de6134d4898960051b016020015190565b8680821191030290565b808218908210021890565b61360d565b5050600101613461565b505f5b8451515181101561353457845151600582901b016020015161352c9060208781015151600585901b0101515f6137bb565b6001016134fb565b505f5b6080850151515181101561357657608085015151600582901b016020015161356e9060a087015151600584901b01602001516137fb565b600101613537565b505050505050505050565b5f8261358d5750505050565b600581901b840135840180358015300217906020808201359160408101350190810190356135be848484848a613856565b5050505083839050816001019150810361358d5750505050565b604080516060815290819052611b7383836001600160a01b03166124e0565b604080516060815290819052611b7383836124e0565b80613616575050565b5f61362083611f91565b90505f5b818110156125be575f6136378583613892565b60ff81165f818152600188016020526040812092935090613665904290600581111561075157610751613ac5565b9050808260020154101561368157600282018190555f60018301555b815f015486836001015f8282546136989190614277565b92505081905511156136bd5760405163483f424d60e11b815260040160405180910390fd5b505050806001019050613624565b60405181518351146136e957634e487b715f5260326020526024601cfd5b82516136f457505050565b5f5f6136ff85613931565b61370885613931565b9150915061371585613960565b61371e856139b5565b848403601f196020870187518752875160051b3684830137845160051b5b8086015181860151835b8281511461375657602001613746565b86018051820180825282111561377857634e487b715f5260116020526024601cfd5b50505082018061373c5750505050826040525050505050565b5f816014526370a0823160601b5f5260208060246010865afa601f3d111660205102905092915050565b816014528060345263095ea7b360601b5f5260205f604460105f875af18060015f511416612bd857803d853b151710612bd857633e3f8f735f526004601cfd5b60405163cc53287f8152602080820152600160408201528260601b60601c60608201528160601b60601c60808201525f3860a0601c84015f6e22d473030f116ddee9f6b43ac78ba35af1610f6e576396b3de235f526004601cfd5b6138628186858561164f565b61387e576040516282b42960e81b815260040160405180910390fd5b61388b85858585856139fe565b5050505050565b5f82546101008310156138c1575f5b8084146138ba57600182198101831690921891016138a1565b50806138ce575b634e23d0355f526004601cfd5b7e1f0d1e100c1d070f090b19131c1706010e11080a1a141802121b15031604056001821901909116608081901c151560071b81811c60401c151560061b1781811c63ffffffff1060051b1790811c63d76453e004601f169190911a179392505050565b604051815160051b8101602001818084035b808201518252816020019150828203613943575060405250919050565b80515f82528060051b8201601f19602084015b6020018281116139ae578051828201805182811161399357505050613973565b5b602082015283018051828111613994575060200152613973565b5050509052565b600281511061100f576020810160408201600183510160051b83015b81518351146139e557602083019250815183525b6020820191508082036139d157505081900360051c9052565b604051828482375f388483888a5af1613a19573d5f823e3d81fd5b505050505050565b5f5f83601f840112613a31575f5ffd5b50813567ffffffffffffffff811115613a48575f5ffd5b602083019150836020828501011115613a5f575f5ffd5b9250929050565b5f5f5f60408486031215613a78575f5ffd5b83359250602084013567ffffffffffffffff811115613a95575f5ffd5b613aa186828701613a21565b9497909650939450505050565b5f60208284031215613abe575f5ffd5b5035919050565b634e487b7160e01b5f52602160045260245ffd5b5f81518084528060208401602086015e5f602082860101526020601f19601f83011685010191505092915050565b6020815264ffffffffff82511660208201525f602083015160038110613b2f57613b2f613ac5565b8060408401525060408301511515606083015260608301516080808401526118da60a0840182613ad9565b6001600160a01b038116811461100f575f5ffd5b8035801515811461280f575f5ffd5b5f5f5f5f60808587031215613b90575f5ffd5b843593506020850135613ba281613b5a565b925060408501356001600160e01b031981168114613bbe575f5ffd5b9150613bcc60608601613b6e565b905092959194509250565b80356006811061280f575f5ffd5b5f5f5f60608486031215613bf7575f5ffd5b833592506020840135613c0981613b5a565b9150613c1760408501613bd7565b90509250925092565b5f5f5f5f60808587031215613c33575f5ffd5b843593506020850135613c4581613b5a565b9250613c5360408601613bd7565b9396929550929360600135925050565b5f5f5f60408486031215613c75575f5ffd5b833567ffffffffffffffff811115613c8b575f5ffd5b8401601f81018613613c9b575f5ffd5b803567ffffffffffffffff811115613cb1575f5ffd5b8660208260051b8401011115613cc5575f5ffd5b6020918201979096509401359392505050565b5f5f5f60608486031215613cea575f5ffd5b833592506020840135613cfc81613b5a565b9150613c1760408501613b6e565b602080825282518282018190525f918401906040840190835b81811015613d4a5783516001600160a01b0316835260209384019390920191600101613d23565b509095945050505050565b60ff60f81b8816815260e060208201525f613d7360e0830189613ad9565b8281036040840152613d858189613ad9565b606084018890526001600160a01b038716608085015260a0840186905283810360c0850152845180825260208087019350909101905f5b81811015613dda578351835260209384019390920191600101613dbc565b50909b9a5050505050505050505050565b5f5f5f60608486031215613dfd575f5ffd5b8335613e0881613b5a565b9250602084013591506040840135613e1f81613b5a565b809150509250925092565b634e487b7160e01b5f52604160045260245ffd5b6040516080810167ffffffffffffffff81118282101715613e6157613e61613e2a565b60405290565b5f82601f830112613e76575f5ffd5b813567ffffffffffffffff811115613e9057613e90613e2a565b604051601f8201601f19908116603f0116810167ffffffffffffffff81118282101715613ebf57613ebf613e2a565b604052818152838201602001851015613ed6575f5ffd5b816020850160208301375f918101602001919091529392505050565b5f60208284031215613f02575f5ffd5b813567ffffffffffffffff811115613f18575f5ffd5b820160808185031215613f29575f5ffd5b613f31613e3e565b813564ffffffffff81168114613f45575f5ffd5b8152602082013560038110613f58575f5ffd5b6020820152613f6960408301613b6e565b6040820152606082013567ffffffffffffffff811115613f87575f5ffd5b613f9386828501613e67565b606083015250949350505050565b5f5f60208385031215613fb2575f5ffd5b823567ffffffffffffffff811115613fc8575f5ffd5b613fd485828601613a21565b90969095509350505050565b602081525f611b736020830184613ad9565b6006811061400257614002613ac5565b9052565b602080825282518282018190525f918401906040840190835b81811015613d4a57835180516001600160a01b031684526020808201519061404990860182613ff2565b506040810151604085015260608101516060850152608081015160808501525060a08301925060208401935060018101905061401f565b5f5f60408385031215614091575f5ffd5b823561409c81613b5a565b91506140aa60208401613b6e565b90509250929050565b5f5f604083850312156140c4575f5ffd5b823591506140aa60208401613bd7565b5f5f5f5f606085870312156140e7575f5ffd5b8435935060208501356140f981613b5a565b9250604085013567ffffffffffffffff811115614114575f5ffd5b61412087828801613a21565b95989497509550505050565b8381526001600160a01b0383166020820152606081016118da6040830184613ff2565b8481526001600160a01b0384166020820152608081016141726040830185613ff2565b82606083015295945050505050565b60208152816020820152818360408301375f818301604090810191909152601f909201601f19160101919050565b634e487b7160e01b5f52603260045260245ffd5b634e487b7160e01b5f52601160045260245ffd5b5f826141f157634e487b7160e01b5f52601260045260245ffd5b500490565b8082028115828204841417610b5c57610b5c6141c3565b5f6020828403121561421d575f5ffd5b8151611b7381613b5a565b5f85518060208801845e60d886901b6001600160d81b0319169083019081526003851061425757614257613ac5565b60f894851b600582015292151590931b6006830152506007019392505050565b80820180821115610b5c57610b5c6141c356fe3232323232323232323232323232323232323232323232323232323232323232a26469706673582212205f73f7f491f6845cef8154c1200059883f28d94744bef75f2c4828a831cf434864736f6c634300081c0033")),
            //     ..Default::default()
            // },
        ),
    ]);

    let res = provider
        .estimate_gas(&TransactionRequest {
            from: Some(Address::ZERO),
            to: Some(to.into()),
            ..Default::default()
        })
        .overrides(&overrides)
        .await;

    dbg!(&res);

    Ok(())
}

#[tokio::test]
#[cfg(unix)]
async fn can_run_eth_node_with_auth_engine_api_over_ipc() -> eyre::Result<()> {
    reth_tracing::init_test_tracing();
    let exec = TaskManager::current();
    let exec = exec.executor();

    // Chain spec with test allocs
    let genesis: Genesis = serde_json::from_str(include_str!("../assets/genesis.json")).unwrap();
    let chain_spec = Arc::new(
        ChainSpecBuilder::default()
            .chain(MAINNET.chain)
            .genesis(genesis)
            .cancun_activated()
            .build(),
    );

    // Node setup
    let node_config = NodeConfig::test()
        .with_chain(chain_spec)
        .with_rpc(RpcServerArgs::default().with_unused_ports().with_http().with_auth_ipc());

    let NodeHandle { node, node_exit_future: _ } = NodeBuilder::new(node_config)
        .testing_node(exec)
        .node(EthereumNode::default())
        .launch()
        .await?;
    let mut node = NodeTestContext::new(node, eth_payload_attributes).await?;

    // Configure wallet from test mnemonic and create dummy transfer tx
    let wallet = Wallet::default();
    let raw_tx = TransactionTestContext::transfer_tx_bytes(1, wallet.inner).await;

    // make the node advance
    let tx_hash = node.rpc.inject_tx(raw_tx).await?;

    // make the node advance
    let (payload, _) = node.advance_block().await?;

    let block_hash = payload.block().hash();
    let block_number = payload.block().number;

    // assert the block has been committed to the blockchain
    node.assert_new_block(tx_hash, block_hash, block_number).await?;

    Ok(())
}

#[tokio::test]
#[cfg(unix)]
async fn test_failed_run_eth_node_with_no_auth_engine_api_over_ipc_opts() -> eyre::Result<()> {
    reth_tracing::init_test_tracing();
    let exec = TaskManager::current();
    let exec = exec.executor();

    // Chain spec with test allocs
    let genesis: Genesis = serde_json::from_str(include_str!("../assets/genesis.json")).unwrap();
    let chain_spec = Arc::new(
        ChainSpecBuilder::default()
            .chain(MAINNET.chain)
            .genesis(genesis)
            .cancun_activated()
            .build(),
    );

    // Node setup
    let node_config = NodeConfig::test().with_chain(chain_spec);
    let NodeHandle { node, node_exit_future: _ } = NodeBuilder::new(node_config)
        .testing_node(exec)
        .node(EthereumNode::default())
        .launch()
        .await?;

    let node = NodeTestContext::new(node, eth_payload_attributes).await?;

    // Ensure that the engine api client is not available
    let client = node.inner.engine_ipc_client().await;
    assert!(client.is_none(), "ipc auth should be disabled by default");

    Ok(())
}
